import pandas as pd
import os
import json
from pathlib import Path
from PIL import Image
import io

# 源 parquet 数据目录
parquet_dir = Path("./tmp/ScreenSpot-v2-mobile/data")
files = list(parquet_dir.glob("*parquet"))

# 目标目录
target_root = Path(os.path.dirname(os.path.dirname(__file__))) / 'ScreenSpot_v2_mobile'
images_dir = target_root / 'images'
jsonl_path = target_root / 'data.jsonl'

# 创建目录
os.makedirs(images_dir, exist_ok=True)

# 写入 jsonl 文件
with open(jsonl_path, 'w', encoding='utf-8') as jsonl_file:
    idx = 0
    for file in files:
        df = pd.read_parquet(file)
        for _, row in df.iterrows():
            # 保存图像
            image_bytes = row['image']['bytes']
            image_name = row['file_name']
            image_path = images_dir / image_name
            image = Image.open(io.BytesIO(image_bytes))
            image.save(image_path)

            # bbox 转换为目标格式
            bbox = row['bbox']
            x1, y1, x2, y2 = [int(b * 1000) for b in bbox]
            bbox_str = f"<|box_start|>({x1},{y1})({x2},{y2})<|box_end|>"

            # 构造 JSON 行
            record = {
                "id": idx,
                "images": [image_name],
                "query": row['instruction'],
                "response": bbox_str
            }
            jsonl_file.write(json.dumps(record, ensure_ascii=False) + "\n")
            idx += 1

print(f"数据已保存到: {target_root}")
