# %%
import os
import json
import shutil
from tqdm import tqdm

# %%
# å½“å‰è·¯å¾„ï¼ˆé€‚é… notebookï¼‰
current_dir = os.getcwd()

# æºæ•°æ®æ‰€åœ¨è·¯å¾„
dataset_dir = os.path.join(current_dir, 'android_control_test', 'test', 'android_control')

# %%
# æ”¶é›† low-level å’Œ high-level æŒ‡ä»¤æ•°æ®
low_level_data = []
high_level_data = []
sample_id = 0

for folder_name in tqdm(sorted(os.listdir(dataset_dir))):
    json_file_path = os.path.join(dataset_dir, folder_name, f"{folder_name}.json")
    with open(json_file_path, 'r') as f:
        sample_list = json.load(f)

    for sample in sample_list:
        image_path = sample['image_path']
        low_level_data.append({
            "id": sample_id,
            "query": sample['low_instruction'],
            "images": [image_path]
        })
        high_level_data.append({
            "id": sample_id,
            "query": sample['instruction'],
            "action_type": sample['result_action_type']
        })
        sample_id += 1

# %%
# é¢„è§ˆ low-level æ ·æœ¬æ ¼å¼
print(low_level_data[:2])

# %%
def process_samples(data_list, output_root_dir, dataset_name):
    print(f"â–¶ æ­£åœ¨å¤„ç†ï¼š{dataset_name}")

    target_dir = os.path.join(output_root_dir, dataset_name)
    images_dir = os.path.join(target_dir, "images")
    os.makedirs(images_dir, exist_ok=True)

    output_jsonl_path = os.path.join(target_dir, f"{dataset_name}.jsonl")

    with open(output_jsonl_path, 'w', encoding='utf-8') as f:
        for item in data_list:
            image_filenames = [os.path.basename(p) for p in item['images']]
            new_item = {
                "id": item["id"],
                "query": item["query"],
                "images": image_filenames
            }
            f.write(json.dumps(new_item, ensure_ascii=False) + '\n')

            # æ‹·è´å›¾ç‰‡åˆ°ç›®æ ‡ images ç›®å½•
            for original_image_path in item['images']:
                dst_path = os.path.join(images_dir, os.path.basename(original_image_path))
                shutil.copy2(original_image_path, dst_path)

    print(f"âœ… å·²ä¿å­˜ï¼š{output_jsonl_path}")
    print(f"ğŸ–¼ï¸  å›¾ç‰‡å¤åˆ¶å®Œæˆï¼š{images_dir}")

# %%
# è¾“å‡ºåˆ°å½“å‰ç›®å½•çš„ä¸Šä¸€çº§
output_base_dir = os.path.dirname(current_dir)

# æ‰¹é‡å¤„ç†ä¸¤ä¸ªæ•°æ®é›†
datasets = {
    "AC-Low": low_level_data,
    "AC-High": high_level_data
}

for dataset_name, dataset_content in datasets.items():
    process_samples(dataset_content, output_base_dir, dataset_name)
