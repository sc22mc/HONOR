#!/bin/bash
set -x  # 开启调试输出

# 设置 NCCL 环境变量（单卡也可以保留，兼容性好）
export NCCL_IB_DISABLE=0
export NCCL_P2P_DISABLE=0
export NCCL_SOCKET_IFNAME=eth0

# 固定模型和数据路径
MODEL_PATH="/opt/nas/p/dongshaokang/fundmental_model/ui_agent_data/gui_task_v630_lock_data/Qwen2-VL-7B_RPA_Aug_v630D_Finish_20250623"
MODEL_TYPE="qwen2_vl"
DATA_PATH="/opt/nas/p/dongshaokang/AgentCPM-GUI/eval/eval_data/android_control_honor_inital_test/finish_android_control_test_hl.jsonl"
OUTPUT_DIR="/opt/nas/p/dongshaokang/AgentCPM-GUI/eval/eval_data/android_control_honor_inital_test/CPT630D/infer_full_hl"
RESULT_PATH="$OUTPUT_DIR/response_ac_hl_nothink.json"
LOG_PATH="$OUTPUT_DIR/infer.log"

# 创建输出目录
mkdir -p "$OUTPUT_DIR"

# 单卡推理
CUDA_VISIBLE_DEVICES=0 swift infer \
    --model "$MODEL_PATH" \
    --model_type "$MODEL_TYPE" \
    --val_dataset "$DATA_PATH" \
    --infer_backend pt \
    --max_batch_size 1 \
    --temperature 0 \
    --result_path "$RESULT_PATH" \
    --max_new_tokens 512 &>> "$LOG_PATH"
