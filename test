import json
import re

def filter_jsonl_by_images(jsonl1_path, jsonl2_path):
    """
    æ ¹æ®ç¬¬ä¸€ä¸ª jsonl æ–‡ä»¶é‡Œçš„ images åˆ—è¡¨ï¼ˆåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼‰æå– screenshot_æ•°å­— ä½œä¸º keyï¼Œ
    ç„¶åè¿‡æ»¤ç¬¬äºŒä¸ª jsonl æ–‡ä»¶ï¼Œåªä¿ç•™ image_path ä¸­åŒ…å«è¿™äº› key çš„è¡Œï¼Œå¹¶ç›´æ¥è¦†ç›–åŸæ–‡ä»¶ã€‚

    :param jsonl1_path: ç¬¬ä¸€ä¸ª jsonl æ–‡ä»¶è·¯å¾„
    :param jsonl2_path: ç¬¬äºŒä¸ª jsonl æ–‡ä»¶è·¯å¾„ï¼ˆä¼šè¢«åŸåœ°ä¿®æ”¹ï¼‰
    """

    # 1. ä»ç¬¬ä¸€ä¸ª jsonl æå– screenshot_æ•°å­— éƒ¨åˆ†
    keys_set = set()
    pattern = re.compile(r"(screenshot_\d+)_\d+\.png")

    with open(jsonl1_path, "r", encoding="utf-8") as f1:
        for line in f1:
            if not line.strip():
                continue
            obj = json.loads(line)
            if "images" in obj and obj["images"]:
                match = pattern.match(obj["images"][0])
                if match:
                    keys_set.add(match.group(1))

    print(f"âœ… ä» {jsonl1_path} æå–åˆ° {len(keys_set)} ä¸ªå”¯ä¸€ key")

    # 2. è¿‡æ»¤ç¬¬äºŒä¸ª jsonl
    filtered_lines = []
    with open(jsonl2_path, "r", encoding="utf-8") as f2:
        for line in f2:
            if not line.strip():
                continue
            obj = json.loads(line)
            image_path = obj.get("image_path", "")
            match = pattern.match(image_path)
            if match and match.group(1) in keys_set:
                filtered_lines.append(json.dumps(obj, ensure_ascii=False))

    print(f"âœ… {jsonl2_path} ä¸­ä¿ç•™ {len(filtered_lines)} è¡Œ")

    # 3. è¦†ç›–å†™å›ç¬¬äºŒä¸ªæ–‡ä»¶
    with open(jsonl2_path, "w", encoding="utf-8") as f2:
        for line in filtered_lines:
            f2.write(line + "\n")

    print("ğŸ¯ å¤„ç†å®Œæˆï¼")


# ä½¿ç”¨ç¤ºä¾‹
# filter_jsonl_by_images("file1.jsonl", "file2.jsonl")
